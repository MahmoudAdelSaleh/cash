<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>الهادي ماركت - نسخة أوفلاين</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary-color: #007bff; --secondary-color: #343a40; --success-color: #28a745;
    --danger-color: #dc3545; --warning-color: #ffc107; --text-dark: #222;
    --bg-light: #f8f9fa; --white: #fff; --border-color: #dee2e6;
    --shadow-light: 0 0 6px rgba(0, 0, 0, 0.1);
  }
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg-light); color: var(--text-dark); direction: rtl; }
  #app-container { display: none; }
  header { background: var(--primary-color); color: var(--white); padding: 15px; text-align: center; font-size: 24px; display: flex; justify-content: space-between; align-items: center; }
  nav { display: flex; background: var(--secondary-color); overflow-x: auto; }
  nav button { flex: 1; flex-shrink: 0; padding: 12px 10px; border: none; background: var(--secondary-color); color: var(--white); font-size: 16px; cursor: pointer; transition: background 0.3s; }
  nav button.active, nav button:hover { background: #0056b3; }
  nav button.hidden { display: none; }
  main { padding: 15px; max-width: 900px; margin: auto; }
  section { display: none; }
  section.active { display: block; }
  input, select, button, table { font-size: 16px; }
  input, select { width: 100%; padding: 10px; margin: 6px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
  button { background: var(--primary-color); color: var(--white); border: none; padding: 10px; border-radius: 4px; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  button:disabled { background: #6c757d; cursor: not-allowed; }
  button:hover:not(:disabled) { background: #0056b3; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; vertical-align: middle; }
  th { background: #e9ecef; }
  .btn-small { padding: 5px 10px; font-size: 14px; margin: 0 2px; }
  .btn-danger { background: var(--danger-color); }
  .btn-warning { background: var(--warning-color); color: var(--text-dark); }
  .summary-box, .card { background: var(--white); padding: 15px; margin: 15px 0; border-radius: 6px; box-shadow: var(--shadow-light); }
  .card { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
  .form-group { margin-bottom: 15px; }
  .flex-container { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .flex-end { justify-content: flex-end; }
  #notification-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
  .notification { background-color: rgba(0, 0, 0, 0.8); color: white; padding: 15px 25px; border-radius: 8px; opacity: 0; transition: opacity 0.5s ease-in-out; }
  .notification.show { opacity: 1; }
  #login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
  #login-form { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 350px; text-align: center; }
  #logoutBtn { background: var(--danger-color); }
</style>
</head>
<body>

<div id="app-container">
  <header>
    <span>الهادي ماركت (أوفلاين)</span>
    <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> خروج</button>
  </header>
  <nav>
    <button data-tab="items"><i class="fas fa-box"></i> الأصناف</button>
    <button data-tab="customers"><i class="fas fa-users"></i> العملاء</button>
    <button class="active" data-tab="sales"><i class="fas fa-cash-register"></i> المبيعات</button>
    <button data-tab="invoices"><i class="fas fa-file-invoice"></i> الفواتير</button>
    <button data-tab="summary"><i class="fas fa-chart-bar"></i> التقارير</button>
    <button data-tab="users" class="hidden"><i class="fas fa-user-shield"></i> المستخدمين</button>
  </nav>

  <main>
    <section id="items">
      <h2><i class="fas fa-box"></i> إدارة الأصناف</h2>
      <div class="summary-box">
          <div class="form-group flex-container">
            <input type="text" id="itemCode" placeholder="الباركود (المعرّف)" />
            <input type="text" id="itemName" placeholder="اسم الصنف" />
            <input type="number" id="itemPrice" placeholder="السعر" min="0" />
            <input type="number" id="itemStock" placeholder="الكمية" min="0" />
            <button id="saveItemBtn"><i class="fas fa-save"></i> حفظ</button>
          </div>
      </div>
      <table>
          <thead><tr><th>باركود</th><th>اسم</th><th>سعر</th><th>كمية</th><th>تعديل/حذف</th></tr></thead>
          <tbody id="itemsTable"></tbody>
      </table>
    </section>

    <section id="customers">
       <h2><i class="fas fa-users"></i> إدارة العملاء</h2>
       <div class="summary-box">
           <div class="form-group flex-container">
               <input type="text" id="customerId" placeholder="رقم العميل (الهاتف)" />
               <input type="text" id="customerName" placeholder="اسم العميل" />
               <button id="saveCustomerBtn"><i class="fas fa-save"></i> حفظ</button>
           </div>
       </div>
       <div id="customersList"></div>
    </section>

    <section id="sales" class="active">
        <h2><i class="fas fa-cash-register"></i> قسم المبيعات (قيد التطوير)</h2>
    </section>

    <section id="invoices">
        <h2><i class="fas fa-file-invoice-dollar"></i> الفواتير (قيد التطوير)</h2>
    </section>

    <section id="summary">
        <h2><i class="fas fa-chart-bar"></i> النسخ الاحتياطي والاستعادة</h2>
        <div class="summary-box">
            <p>يمكنك حفظ جميع بياناتك الحالية (أصناف، عملاء، الخ) في ملف JSON على جهازك، أو استعادة البيانات من ملف تم حفظه مسبقاً.</p>
            <div class="flex-container flex-end" style="gap: 15px; margin-top: 20px;">
                <button id="backupBtn" class="btn-success"><i class="fas fa-download"></i> نسخة احتياطية</button>
                <button id="restoreBtn" class="btn-warning"><i class="fas fa-upload"></i> استعادة نسخة</button>
                <input type="file" id="restoreInput" accept=".json" style="display: none;" />
          </div>
        </div>
    </section>
    
    <section id="users">
        <h2><i class="fas fa-user-shield"></i> إدارة المستخدمين</h2>
        <div class="summary-box">
           <div class="form-group flex-container">
               <input type="text" id="usernameInput" placeholder="اسم المستخدم" />
               <input type="password" id="passwordInput" placeholder="كلمة المرور" />
               <select id="userRoleSelect"><option value="user">مستخدم عادي</option><option value="admin">مدير</option></select>
               <button id="saveUserBtn"><i class="fas fa-plus-circle"></i> إضافة</button>
           </div>
       </div>
       <div id="usersList"></div>
    </section>
  </main>
</div>

<div id="login-container">
    <form id="login-form">
        <h2><i class="fas fa-lock"></i> تسجيل الدخول</h2>
        <div class="form-group"><input type="text" id="loginUsername" placeholder="اسم المستخدم" required /></div>
        <div class="form-group"><input type="password" id="loginPassword" placeholder="كلمة المرور" required /></div>
        <button type="submit" id="loginBtn">دخول</button>
    </form>
</div>

<div id="notification-container"></div>

<script type="module">
    // --- DOM Elements ---
    const DOM = {
        app: document.getElementById('app-container'),
        login: document.getElementById('login-container'),
        loginForm: document.getElementById('login-form'),
        navButtons: document.querySelectorAll('nav button'),
        notificationContainer: document.getElementById('notification-container'),
        logoutBtn: document.getElementById('logoutBtn'),
        // Items
        saveItemBtn: document.getElementById('saveItemBtn'),
        itemCode: document.getElementById('itemCode'),
        itemName: document.getElementById('itemName'),
        itemPrice: document.getElementById('itemPrice'),
        itemStock: document.getElementById('itemStock'),
        itemsTable: document.getElementById('itemsTable'),
        // Customers
        saveCustomerBtn: document.getElementById('saveCustomerBtn'),
        customerId: document.getElementById('customerId'),
        customerName: document.getElementById('customerName'),
        customersList: document.getElementById('customersList'),
        // Users
        saveUserBtn: document.getElementById('saveUserBtn'),
        usernameInput: document.getElementById('usernameInput'),
        passwordInput: document.getElementById('passwordInput'),
        userRoleSelect: document.getElementById('userRoleSelect'),
        usersList: document.getElementById('usersList'),
        // Backup & Restore
        backupBtn: document.getElementById('backupBtn'),
        restoreBtn: document.getElementById('restoreBtn'),
        restoreInput: document.getElementById('restoreInput'),
    };

    // --- Application State ---
    let state = {
        currentUser: null,
        editingItemId: null,
        editingCustomerId: null,
        editingUserId: null,
        data: {
            items: [],
            customers: [],
            users: [],
            invoices: [],
            config: {}
        }
    };

    // --- Data Manager (Handles localStorage and JSON) ---
    const DataManager = {
        async initialize() {
            const localData = localStorage.getItem('appData');
            if (localData) {
                state.data = JSON.parse(localData);
                console.log('Data loaded from localStorage.');
            } else {
                try {
                    const response = await fetch('data.json');
                    if (!response.ok) throw new Error('Network response was not ok');
                    state.data = await response.json();
                    this.save();
                    console.log('Initial data loaded from data.json.');
                } catch (error) {
                    console.error('Failed to fetch initial data:', error);
                    showNotification('فشل تحميل البيانات الأولية. تأكد من وجود ملف data.json', 'danger');
                }
            }
        },
        save() {
            localStorage.setItem('appData', JSON.stringify(state.data));
        }
    };
    
    // --- UI Functions ---
    const showNotification = (message, type = 'success') => {
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        DOM.notificationContainer.appendChild(notif);
        setTimeout(() => notif.classList.add('show'), 10);
        setTimeout(() => {
            notif.classList.remove('show');
            setTimeout(() => notif.remove(), 500);
        }, 3000);
    };

    const switchTab = (tabId) => {
        document.querySelectorAll('main section').forEach(s => s.classList.remove('active'));
        document.getElementById(tabId)?.classList.add('active');
        document.querySelectorAll('nav button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabId);
        });
    };

    // --- Authentication ---
    const Auth = {
        login(username, password) {
            const user = state.data.users.find(u => u.username === username && u.password === password);
            const isAdmin = password === state.data.config.adminPin;

            if (isAdmin) {
                state.currentUser = { username: 'المدير العام', role: 'admin' };
            } else if (user) {
                state.currentUser = user;
            }

            if (state.currentUser) {
                sessionStorage.setItem('currentUser', JSON.stringify(state.currentUser));
                this.showApp();
            } else {
                showNotification('اسم المستخدم أو كلمة المرور غير صحيحة', 'danger');
            }
        },
        logout() {
            state.currentUser = null;
            sessionStorage.removeItem('currentUser');
            DOM.app.style.display = 'none';
            DOM.login.style.display = 'flex';
        },
        showApp() {
            DOM.login.style.display = 'none';
            DOM.app.style.display = 'block';
            document.querySelector('button[data-tab="users"]').classList.toggle('hidden', state.currentUser.role !== 'admin');
            switchTab('sales');
        },
        checkSession() {
            const user = sessionStorage.getItem('currentUser');
            if (user) {
                state.currentUser = JSON.parse(user);
                this.showApp();
            }
        }
    };

    // --- Items Controller ---
    const ItemsController = {
        render() {
            DOM.itemsTable.innerHTML = state.data.items.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.price}</td>
                    <td>${item.stock}</td>
                    <td>
                        <button class="btn-small btn-warning edit-item" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn-small btn-danger delete-item" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        },
        save() {
            const id = DOM.itemCode.value.trim();
            const name = DOM.itemName.value.trim();
            const price = parseFloat(DOM.itemPrice.value);
            const stock = parseInt(DOM.itemStock.value);

            if (!id || !name || isNaN(price) || isNaN(stock)) {
                showNotification('يرجى ملء جميع الحقول بشكل صحيح', 'danger');
                return;
            }
            
            const existingItem = state.data.items.find(item => item.id === id);

            if (state.editingItemId && state.editingItemId !== id) {
                 showNotification('لا يمكن تغيير الباركود أثناء التعديل', 'danger');
                 return;
            }
            if (!state.editingItemId && existingItem) {
                showNotification('هذا الباركود موجود بالفعل', 'danger');
                return;
            }

            if (state.editingItemId) { // Update
                const item = state.data.items.find(i => i.id === state.editingItemId);
                item.name = name;
                item.price = price;
                item.stock = stock;
            } else { // Create
                state.data.items.push({ id, name, price, stock });
            }

            DataManager.save();
            this.render();
            this.clearForm();
        },
        edit(id) {
            const item = state.data.items.find(i => i.id === id);
            if (!item) return;
            state.editingItemId = id;
            DOM.itemCode.value = item.id;
            DOM.itemName.value = item.name;
            DOM.itemPrice.value = item.price;
            DOM.itemStock.value = item.stock;
            DOM.saveItemBtn.innerHTML = '<i class="fas fa-edit"></i> تعديل';
        },
        delete(id) {
            if (confirm('هل أنت متأكد من حذف هذا الصنف؟')) {
                state.data.items = state.data.items.filter(i => i.id !== id);
                DataManager.save();
                this.render();
            }
        },
        clearForm() {
            state.editingItemId = null;
            DOM.itemCode.value = '';
            DOM.itemName.value = '';
            DOM.itemPrice.value = '';
            DOM.itemStock.value = '';
            DOM.saveItemBtn.innerHTML = '<i class="fas fa-save"></i> حفظ';
        }
    };
    
    // --- Customers & Users Controllers (Similar structure) ---
    // Placeholder for Customer/User logic to be filled in similarly
    const CustomersController = {
        render() {
             DOM.customersList.innerHTML = state.data.customers.map(c => `
                <div class="card">
                    <div><b>${c.name}</b><br/><small>${c.id}</small></div>
                    <div class="flex-container">
                        <button class="btn-small btn-warning edit-customer" data-id="${c.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn-small btn-danger delete-customer" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        },
        save(){ /* ... */ }, edit(id){ /* ... */ }, delete(id){ /* ... */ }, clearForm(){ /* ... */ }
    };
     const UsersController = {
        render() { /* ... */ }, save(){ /* ... */ }, edit(id){ /* ... */ }, delete(id){ /* ... */ }, clearForm(){ /* ... */ }
    };

    // --- Backup & Restore ---
    const BackupRestore = {
        backup() {
            const dataStr = JSON.stringify(state.data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('تم إنشاء النسخة الاحتياطية بنجاح.');
        },
        restore(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    // Basic validation
                    if (restoredData.items && restoredData.customers && restoredData.users) {
                        state.data = restoredData;
                        DataManager.save();
                        showNotification('تم استعادة البيانات بنجاح! سيتم إعادة تحميل الصفحة.');
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        throw new Error('Invalid file structure');
                    }
                } catch (err) {
                    showNotification('خطأ في قراءة الملف. تأكد من أنه ملف نسخة احتياطية صالح.', 'danger');
                }
            };
            reader.readAsText(file);
        }
    };

    // --- Event Listeners ---
    function setupEventListeners() {
        DOM.navButtons.forEach(btn => btn.onclick = () => switchTab(btn.dataset.tab));
        DOM.loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            Auth.login(username, password);
        });
        DOM.logoutBtn.onclick = Auth.logout;
        
        // Items
        DOM.saveItemBtn.onclick = () => ItemsController.save();
        DOM.itemsTable.addEventListener('click', e => {
            if (e.target.closest('.edit-item')) ItemsController.edit(e.target.closest('.edit-item').dataset.id);
            if (e.target.closest('.delete-item')) ItemsController.delete(e.target.closest('.delete-item').dataset.id);
        });
        
        // Backup & Restore
        DOM.backupBtn.onclick = BackupRestore.backup;
        DOM.restoreBtn.onclick = () => DOM.restoreInput.click();
        DOM.restoreInput.onchange = BackupRestore.restore;
    }

    // --- App Initialization ---
    async function main() {
        await DataManager.initialize();
        Auth.checkSession();
        setupEventListeners();
        ItemsController.render();
        CustomersController.render();
        // UsersController.render();
    }

    main();
</script>
</body>
</html>
