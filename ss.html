<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>كاشير متكامل - Firebase</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  :root {
    --primary-color: #007bff;
    --secondary-color: #343a40;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --text-dark: #222;
    --bg-light: #f8f9fa;
    --white: #fff;
    --border-color: #dee2e6;
    --shadow-light: 0 0 6px rgba(0, 0, 0, 0.1);
  }

  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg-light); color: var(--text-dark); direction: rtl; }
  #app-container { display: none; }
  header { background: var(--primary-color); color: var(--white); padding: 15px; text-align: center; font-size: 24px; display: flex; justify-content: space-between; align-items: center; }
  nav { display: flex; background: var(--secondary-color); }
  nav button { flex: 1; padding: 12px 0; border: none; background: var(--secondary-color); color: var(--white); font-size: 16px; cursor: pointer; transition: background 0.3s; }
  nav button.active, nav button:hover { background: #0056b3; }
  nav button.hidden { display: none; }
  main { padding: 15px; max-width: 900px; margin: auto; }
  section { display: none; }
  section.active { display: block; }
  input, select, button, table { font-size: 16px; }
  input, select { width: 100%; padding: 10px; margin: 6px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
  input[type="number"] { -moz-appearance: textfield; }
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  button { background: var(--primary-color); color: var(--white); border: none; padding: 10px; border-radius: 4px; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  button:hover { background: #0056b3; }
  button:disabled { background-color: #6c757d; cursor: not-allowed; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; vertical-align: middle; }
  th { background: #e9ecef; }
  .btn-small { padding: 5px 10px; font-size: 14px; margin: 0 2px; border-radius: 3px; }
  .btn-danger { background: var(--danger-color); }
  .btn-danger:hover { background: #a71d2a; }
  .btn-success { background: var(--success-color); }
  .btn-success:hover { background: #1e7e34; }
  .btn-warning { background: var(--warning-color); color: var(--text-dark); }
  .btn-warning:hover { background: #d39e00; }
  .summary-box, .customer-card { background: var(--white); padding: 15px; margin: 15px 0; border-radius: 6px; box-shadow: var(--shadow-light); }
  #customerSuggestions { background: var(--white); max-height: 180px; overflow-y: auto; border: 1px solid #ccc; border-top: none; display: none; position: absolute; z-index: 1000; width: 100%; box-sizing: border-box; }
  #customerSuggestions div { padding: 8px; cursor: pointer; border-bottom: 1px solid #ddd; }
  #customerSuggestions div:hover { background: var(--primary-color); color: var(--white); }
  .customer-card { margin-bottom: 10px; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
  .flex-container { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .flex-end { justify-content: flex-end; }
  #notification-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; max-width: 90%; }
  .notification { background-color: rgba(0, 0, 0, 0.8); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-align: center; font-size: 16px; opacity: 0; transition: opacity 0.5s ease-in-out; }
  .notification.show { opacity: 1; }
  #login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #e9ecef; }
  #login-form { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 350px; text-align: center; }
  #logoutBtn { background: var(--danger-color); }
  .item-card { border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--white); box-shadow: var(--shadow-light); }
  .item-card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: var(--primary-color); }
  .item-card h5 { margin: 5px 0; font-size: 14px; height: 40px; overflow: hidden; }
  .item-card p { margin: 5px 0; font-size: 12px; color: var(--success-color); font-weight: bold; }
  #salesCategoryFilters button.active { background-color: var(--success-color); color: white; }
  #barcode-scanner-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1001; border: 2px solid var(--primary-color); }
  #reader { width: 100%; }
  #closeScannerBtn { margin-top: 15px; width: 100%; }
  #paymentMethodRadios { display: flex; gap: 15px; align-items: center; }
  #paymentMethodRadios label { margin-left: 5px; margin-bottom: 0; }
  #paymentMethodRadios input { width: auto; margin: 0; }
  .input-group { display: flex; align-items: center; }
  .input-group-field { text-align: center; border-radius: 0; padding: 5px 10px; height: 38px; border-left: none; border-right: none; width: 70px; flex-grow: 0 !important; }
  .input-group-btn { border-radius: 0; padding: 5px 12px; font-size: 18px; line-height: 1; height: 38px; flex-shrink: 0; }
  #decreaseDeliveryBtn { border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
  #increaseDeliveryBtn { border-top-left-radius: 4px; border-bottom-left-radius: 4px; }
</style>
</head>
<body>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  const firebaseConfig = {
    apiKey: "AIzaSyAWhNkYnC2n4iuHvdp1O_-S5suxivDidgc",
    authDomain: "cash-84acc.firebaseapp.com",
    projectId: "cash-84acc",
    storageBucket: "cash-84acc.appspot.com",
    messagingSenderId: "774737678098",
    appId: "1:774737678098:web:8b918375b4e51692b7edcb",
    measurementId: "G-GRKNPJ45N1"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window.addDocument = async (collectionName, data) => await addDoc(collection(db, collectionName), { ...data, createdAt: serverTimestamp() });
  window.readCollection = (collectionName, callback, orderByField = "createdAt", orderDirection = "desc") => {
    const q = query(collection(db, collectionName), orderBy(orderByField, orderDirection));
    return onSnapshot(q, snapshot => callback(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
  };
  window.getDocument = async (collectionName, docId) => {
    const docSnap = await getDoc(doc(db, collectionName, docId));
    return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
  };
  window.updateDocument = async (collectionName, docId, data) => await updateDoc(doc(db, collectionName, docId), data);
  window.deleteDocument = async (collectionName, docId) => await deleteDoc(doc(db, collectionName, docId));
</script>

<div id="login-container">
    <form id="login-form">
        <h2><i class="fas fa-lock"></i> تسجيل الدخول</h2>
        <div class="form-group"><input type="text" id="usernameInput" placeholder="اسم المستخدم" required /></div>
        <div class="form-group"><input type="password" id="passwordInput" placeholder="كلمة المرور" required /></div>
        <button type="submit" id="loginBtn"><i class="fas fa-sign-in-alt"></i> دخول</button>
    </form>
</div>

<div id="app-container">
  <header><span>كاشير متكامل</span><button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> خروج</button></header>
  <nav>
    <button data-tab="items"><i class="fas fa-box"></i> الأصناف</button>
    <button data-tab="customers"><i class="fas fa-users"></i> العملاء</button>
    <button class="active" data-tab="sales"><i class="fas fa-cash-register"></i> المبيعات</button>
    <button data-tab="invoices"><i class="fas fa-file-invoice"></i> الفواتير</button>
    <button data-tab="summary"><i class="fas fa-chart-bar"></i> التقارير</button>
    <button data-tab="users" class="hidden"><i class="fas fa-user-shield"></i> المستخدمون</button>
  </nav>

  <main>
    <section id="sales" class="active">
      <h2><i class="fas fa-cash-register"></i> عملية بيع</h2>
      <div id="categoryContainer" style="margin-bottom: 20px;">
        <button id="showCategoriesBtn" style="width: 100%; padding: 15px; font-size: 18px;" class="btn-success"><i class="fas fa-tags"></i> عرض الفئات</button>
      </div>
      <div id="salesCategoryFilters" class="flex-container" style="justify-content: flex-start; margin-bottom: 15px; display: none;"></div>
      <div id="categoryPagination" style="display: none; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <button id="prevCategoriesBtn" class="btn-small btn-warning"><i class="fas fa-arrow-right"></i> السابق</button>
          <span id="categoryPageIndicator" style="font-weight: bold;"></span>
          <button id="nextCategoriesBtn" class="btn-small btn-warning">التالي <i class="fas fa-arrow-left"></i></button>
      </div>
      <div id="itemGrid" style="display: none; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;"></div>
      <div class="form-group" style="text-align: center; margin-top: -10px; margin-bottom: 20px;">
        <button id="hideCategoriesBtn" class="btn-warning" style="display:none;"><i class="fas fa-eye-slash"></i> إخفاء الفئات والأصناف</button>
      </div>
      <div class="form-group" style="position: relative;">
          <div class="flex-container">
              <input type="text" id="customerName" placeholder="اسم العميل (اختياري)" autocomplete="off" />
              <input type="tel" id="customerPhone" placeholder="رقم هاتف العميل (واتساب)" />
          </div>
          <div id="customerSuggestions"></div>
      </div>
      <div class="form-group">
        <button id="scanBarcodeBtn" style="width:100%;"><i class="fas fa-camera"></i> مسح باركود صنف</button>
      </div>
      <div class="form-group flex-container">
          <label for="deliveryFeeInput" style="flex: 0 1 auto;">خدمة التوصيل:</label>
          <div class="input-group" style="flex: 1 1 150px;">
              <button id="decreaseDeliveryBtn" class="input-group-btn btn-warning">-</button>
              <input type="number" id="deliveryFeeInput" value="30" min="0" step="5" class="input-group-field" />
              <button id="increaseDeliveryBtn" class="input-group-btn btn-success">+</button>
          </div>
          <span style="flex: 2 1 auto; font-weight: bold;">ج.م</span>
      </div>
      <h3><i class="fas fa-file-invoice"></i> تفاصيل الفاتورة</h3>
      <table>
        <thead><tr><th>الصنف</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th><th>حذف</th></tr></thead>
        <tbody id="invoiceTable"></tbody>
      </table>
      <h4 style="text-align: left;">إجمالي الأصناف: <span id="itemsSubtotal">0.00</span> ج.م</h4>
      <h3 style="text-align: left;">الإجمالي الكلي: <span id="invoiceTotal">0.00</span> ج.م</h3>
      <div class="form-group flex-container">
        <label for="amountPaidInput">المدفوع:</label>
        <input type="number" id="amountPaidInput" placeholder="المبلغ المدفوع" min="0" step="0.01" />
      </div>
      <div class="form-group">
        <label>طريقة الدفع:</label>
        <div id="paymentMethodRadios">
            <input type="radio" id="payCash" name="paymentMethod" value="cash" checked> <label for="payCash">نقداً</label>
            <input type="radio" id="payVisa" name="paymentMethod" value="visa"> <label for="payVisa">فيزا</label>
            <input type="radio" id="payWallet" name="paymentMethod" value="wallet"> <label for="payWallet">محفظة</label>
        </div>
      </div>
      <h3 style="text-align: left;">
        <span id="changeText">الباقي للعميل:</span><span id="changeAmount">0.00</span> ج.م
      </h3>
      <div class="flex-container flex-end" style="margin-top: 20px; flex-direction: row !important; gap: 10px;">
        <button id="sendWhatsappBtn" class="btn-success" style="background-color: #25D366;"><i class="fab fa-whatsapp"></i> واتساب</button>
        <button id="printInvoiceBtn" class="btn-success"><i class="fas fa-print"></i> طباعة</button>
        <button id="saveInvoiceBtn"><i class="fas fa-save"></i> حفظ</button>
      </div>
    </section>
    </main>
</div>

<div id="barcode-scanner-container" style="display:none;">
    <div id="reader"></div>
    <button id="closeScannerBtn" class="btn-danger btn-small">إغلاق الكاميرا</button>
</div>
<div id="notification-container"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const DOM = {
        appContainer: document.getElementById("app-container"),
        loginContainer: document.getElementById("login-container"),
        loginForm: document.getElementById("login-form"),
        usernameInput: document.getElementById("usernameInput"),
        passwordInput: document.getElementById("passwordInput"),
        logoutBtn: document.getElementById("logoutBtn"),
        navButtons: document.querySelectorAll("nav button"),
        sections: document.querySelectorAll("main section"),
        customerNameInput: document.getElementById("customerName"),
        customerPhoneInput: document.getElementById("customerPhone"),
        customerSuggestionsDiv: document.getElementById("customerSuggestions"),
        invoiceTable: document.getElementById("invoiceTable"),
        itemsSubtotalSpan: document.getElementById("itemsSubtotal"),
        invoiceTotalSpan: document.getElementById("invoiceTotal"),
        saveInvoiceBtn: document.getElementById("saveInvoiceBtn"),
        printInvoiceBtn: document.getElementById("printInvoiceBtn"),
        amountPaidInput: document.getElementById("amountPaidInput"),
        changeTextSpan: document.getElementById("changeText"),
        changeAmountSpan: document.getElementById("changeAmount"),
        showCategoriesBtn: document.getElementById("showCategoriesBtn"),
        salesCategoryFilters: document.getElementById("salesCategoryFilters"),
        categoryPagination: document.getElementById("categoryPagination"),
        prevCategoriesBtn: document.getElementById("prevCategoriesBtn"),
        nextCategoriesBtn: document.getElementById("nextCategoriesBtn"),
        categoryPageIndicator: document.getElementById("categoryPageIndicator"),
        itemGrid: document.getElementById("itemGrid"),
        scanBarcodeBtn: document.getElementById("scanBarcodeBtn"),
        barcodeScannerContainer: document.getElementById("barcode-scanner-container"),
        closeScannerBtn: document.getElementById("closeScannerBtn"),
        deliveryFeeInput: document.getElementById("deliveryFeeInput"),
        increaseDeliveryBtn: document.getElementById("increaseDeliveryBtn"),
        decreaseDeliveryBtn: document.getElementById("decreaseDeliveryBtn"),
        sendWhatsappBtn: document.getElementById("sendWhatsappBtn"),
        hideCategoriesBtn: document.getElementById("hideCategoriesBtn"),
        notificationContainer: document.getElementById("notification-container")
    };

    let appState = {
        items: [], invoices: [], customers: [], users: [], adminPIN: null, currentUser: null,
        currentInvoice: [], deliveryFee: 30, editingCustomerId: null,
        selectedCustomer: null, allCategories: [], categoryCurrentPage: 1, 
        categoriesPerPage: 20, html5QrCode: null
    };

    const Helpers = {
        showNotification: (message, duration = 3000) => {
            const notification = document.createElement("div");
            notification.className = "notification";
            notification.textContent = message;
            DOM.notificationContainer.appendChild(notification);
            setTimeout(() => notification.classList.add("show"), 10);
            setTimeout(() => {
                notification.classList.remove("show");
                setTimeout(() => notification.remove(), 500);
            }, duration);
        },
        calculateChange: () => {
            const total = parseFloat(DOM.invoiceTotalSpan.textContent) || 0;
            const paid = parseFloat(DOM.amountPaidInput.value) || 0;
            const change = paid - total;
            DOM.changeTextSpan.textContent = change >= 0 ? "الباقي:" : "المطلوب:";
            DOM.changeAmountSpan.textContent = Math.abs(change).toFixed(2);
        }
    };

    const Auth = {
        login: (username, password) => {
            const pin = password.replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d));
            if (pin === appState.adminPIN) {
                appState.currentUser = { username: "المدير", role: "admin" };
                localStorage.setItem('currentUser', JSON.stringify(appState.currentUser));
                Auth.showApp("admin");
                return;
            }
            const user = appState.users.find(u => u.username === username && u.password === pin);
            if (user) {
                appState.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                Auth.showApp("user");
            } else { Helpers.showNotification("بيانات الدخول غير صحيحة"); }
        },
        logout: () => {
            appState.currentUser = null;
            localStorage.removeItem('currentUser');
            DOM.appContainer.style.display = "none";
            DOM.loginContainer.style.display = "flex";
        },
        showApp: (role) => {
            DOM.loginContainer.style.display = "none";
            DOM.appContainer.style.display = "block";
            document.querySelector('[data-tab="users"]').style.display = role === "admin" ? 'flex' : 'none';
            document.querySelector('[data-tab="sales"]').click();
        }
    };
    
    const SalesController = {
        initSalesPage: () => {
            DOM.showCategoriesBtn.style.display = 'block';
            DOM.salesCategoryFilters.style.display = 'none';
            DOM.categoryPagination.style.display = 'none';
            DOM.itemGrid.style.display = 'none';
            DOM.hideCategoriesBtn.style.display = 'none';
            appState.deliveryFee = 30;
            DOM.deliveryFeeInput.value = 30;
            SalesController.renderInvoice();
        },
        renderCategoryFilters: () => {
            DOM.hideCategoriesBtn.style.display = 'inline-flex';
            const { allCategories, categoryCurrentPage, categoriesPerPage } = appState;
            const totalPages = Math.ceil(allCategories.length / categoriesPerPage);
            const startIndex = (categoryCurrentPage - 1) * categoriesPerPage;
            const categoriesToRender = allCategories.slice(startIndex, startIndex + categoriesPerPage);
            DOM.salesCategoryFilters.innerHTML = categoriesToRender.map(cat => `<button class="btn-small" data-category="${cat}">${cat}</button>`).join("");
            DOM.salesCategoryFilters.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', e => {
                    DOM.salesCategoryFilters.querySelectorAll('button').forEach(b => b.classList.remove('active', 'btn-success'));
                    e.currentTarget.classList.add('active', 'btn-success');
                    SalesController.renderItemsGrid(e.currentTarget.dataset.category);
                });
            });
            DOM.categoryPageIndicator.textContent = `صفحة ${categoryCurrentPage} / ${totalPages}`;
            DOM.prevCategoriesBtn.disabled = categoryCurrentPage === 1;
            DOM.nextCategoriesBtn.disabled = categoryCurrentPage >= totalPages;
        },
        renderItemsGrid: (category) => {
            DOM.itemGrid.style.display = 'grid';
            DOM.hideCategoriesBtn.style.display = 'inline-flex';
            const itemsToRender = appState.items.filter(item => item.category === category && item.stock > 0);
            DOM.itemGrid.innerHTML = itemsToRender.map(item => `<div class="item-card" data-id="${item.id}"><h5>${item.name}</h5><p>${item.price.toFixed(2)} ج.م</p></div>`).join("");
            DOM.itemGrid.querySelectorAll('.item-card').forEach(card => {
                card.addEventListener('click', () => {
                    const itemToAdd = appState.items.find(item => item.id === card.dataset.id);
                    if (itemToAdd) SalesController.addToInvoice(itemToAdd);
                });
            });
        },
        updateTotal: () => {
            const itemsSubtotal = appState.currentInvoice.reduce((sum, item) => sum + item.price * item.qty, 0);
            appState.deliveryFee = parseFloat(DOM.deliveryFeeInput.value) || 0;
            const total = itemsSubtotal + appState.deliveryFee;
            DOM.itemsSubtotalSpan.textContent = itemsSubtotal.toFixed(2);
            DOM.invoiceTotalSpan.textContent = total.toFixed(2);
            Helpers.calculateChange();
        },
        renderInvoice: () => {
            DOM.invoiceTable.innerHTML = appState.currentInvoice.map((item, index) =>
                `<tr><td>${item.name}</td><td><div class="flex-container" style="justify-content:center;flex-wrap:nowrap;"><button class="btn-small btn-warning decrease-invoice-qty-btn" data-index="${index}">-</button><span style="padding:0 10px;font-weight:bold;">${item.qty}</span><button class="btn-small btn-success increase-invoice-qty-btn" data-index="${index}">+</button></div></td><td>${item.price.toFixed(2)}</td><td>${(item.price * item.qty).toFixed(2)}</td><td><button class="btn-small btn-danger remove-from-invoice-btn" data-index="${index}"><i class="fas fa-trash-alt"></i></button></td></tr>`
            ).join("");
            SalesController.updateTotal();
        },
        addToInvoice: (selectedItem) => {
            if (!selectedItem) return;
            const existingItem = appState.currentInvoice.find(i => i.id === selectedItem.id);
            if (existingItem) { existingItem.qty++; } 
            else { appState.currentInvoice.push({ ...selectedItem, qty: 1 }); }
            SalesController.renderInvoice();
            Helpers.showNotification(`تمت إضافة: ${selectedItem.name}`);
        },
        saveInvoice: async () => {
            if (appState.currentInvoice.length === 0) { Helpers.showNotification("لا يمكن حفظ فاتورة فارغة", 4000); return; }
            const invoiceTotal = parseFloat(DOM.invoiceTotalSpan.textContent);
            const newInvoice = {
                customerName: DOM.customerNameInput.value.trim(),
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                amountPaid: parseFloat(DOM.amountPaidInput.value) || 0,
                changeOrBalance: (parseFloat(DOM.amountPaidInput.value) || 0) - invoiceTotal,
                items: [...appState.currentInvoice],
                deliveryFee: appState.deliveryFee,
                total: invoiceTotal,
            };
            try {
                await window.addDocument("invoices", newInvoice);
                Helpers.showNotification("تم حفظ الفاتورة بنجاح!");
                appState.currentInvoice = [];
                DOM.customerNameInput.value = "";
                DOM.customerPhoneInput.value = "";
                DOM.amountPaidInput.value = "";
                appState.selectedCustomer = null;
                DOM.deliveryFeeInput.value = 30; // Correctly reset to 30
                SalesController.renderInvoice();
            } catch (error) {
                console.error("Save Invoice Error:", error);
                Helpers.showNotification("حدث خطأ أثناء حفظ الفاتورة. راجع الـ console.", 5000);
            }
        },
    };

    const App = {
        init: async () => {
            App.bindEvents();
            App.listenToFirebase();
            try {
                const response = await fetch('p.json');
                const itemsData = await response.json();
                const categoryKey = "category ";
                appState.items = itemsData.filter(item => item.status === true)
                    .map(item => ({ id: item.sku, code: item.sku, name: item.name, price: parseFloat(item.price) || 0, category: item[categoryKey]?.trim() || "غير مصنف", unit: "قطعة", stock: 999 }));
                appState.allCategories = [...new Set(appState.items.map(item => item.category).filter(Boolean))].sort();
                SalesController.initSalesPage();
            } catch (error) { Helpers.showNotification("فشل تحميل ملف الأصناف", 5000); }
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) { appState.currentUser = JSON.parse(savedUser); Auth.showApp(appState.currentUser.role); }
        },
        listenToFirebase: () => {
            window.readCollection("customers", data => appState.customers = data, "name", "asc");
            window.readCollection("invoices", data => appState.invoices = data);
            window.readCollection("users", data => appState.users = data, "username", "asc");
            window.getDocument("config", "admin").then(doc => { appState.adminPIN = doc?.pin || "790707071"; });
        },
        bindEvents: () => {
            DOM.loginForm.addEventListener("submit", e => { e.preventDefault(); Auth.login(DOM.usernameInput.value, DOM.passwordInput.value); });
            DOM.logoutBtn.addEventListener("click", Auth.logout);
            DOM.navButtons.forEach(btn => btn.addEventListener("click", e => {
                DOM.navButtons.forEach(b => b.classList.remove("active"));
                e.currentTarget.classList.add("active");
                DOM.sections.forEach(s => s.classList.remove("active"));
                document.getElementById(e.currentTarget.dataset.tab).classList.add("active");
            }));
            DOM.showCategoriesBtn.addEventListener('click', () => {
                DOM.showCategoriesBtn.style.display = 'none';
                DOM.salesCategoryFilters.style.display = 'flex';
                DOM.categoryPagination.style.display = 'flex';
                SalesController.renderCategoryFilters();
            });
            DOM.hideCategoriesBtn.addEventListener('click', () => SalesController.initSalesPage());
            DOM.nextCategoriesBtn.addEventListener('click', () => { if (appState.categoryCurrentPage < Math.ceil(appState.allCategories.length / appState.categoriesPerPage)) { appState.categoryCurrentPage++; SalesController.renderCategoryFilters(); } });
            DOM.prevCategoriesBtn.addEventListener('click', () => { if (appState.categoryCurrentPage > 1) { appState.categoryCurrentPage--; SalesController.renderCategoryFilters(); } });
            DOM.scanBarcodeBtn.addEventListener('click', () => {
                DOM.barcodeScannerContainer.style.display = 'block';
                if (!appState.html5QrCode) { appState.html5QrCode = new Html5Qrcode("reader"); }
                const onScanSuccess = (decodedText) => {
                    appState.html5QrCode.stop().then(() => {
                        DOM.barcodeScannerContainer.style.display = 'none';
                        let codeToSearch = null;
                        const parts = decodedText.split('|');
                        if (parts.length >= 5) { codeToSearch = parts[4].trim(); }
                        else { let barcode = decodedText.trim(); codeToSearch = barcode.length > 12 ? barcode.slice(-12) : barcode; }
                        const foundItem = appState.items.find(item => item.code === codeToSearch);
                        if (foundItem) { SalesController.addToInvoice(foundItem); }
                        else { Helpers.showNotification(`صنف غير موجود: ${codeToSearch}`); }
                    });
                };
                appState.html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess, () => {})
                .catch(() => Helpers.showNotification("خطأ في تشغيل الكاميرا"));
            });
            DOM.closeScannerBtn.addEventListener('click', () => { if (appState.html5QrCode?.isScanning) { appState.html5QrCode.stop(); } DOM.barcodeScannerContainer.style.display = 'none'; });
            DOM.increaseDeliveryBtn.addEventListener('click', () => { DOM.deliveryFeeInput.value = (parseInt(DOM.deliveryFeeInput.value) || 0) + 5; SalesController.updateTotal(); });
            DOM.decreaseDeliveryBtn.addEventListener('click', () => { const current = parseInt(DOM.deliveryFeeInput.value) || 0; if (current >= 5) DOM.deliveryFeeInput.value = current - 5; SalesController.updateTotal(); });
            DOM.deliveryFeeInput.addEventListener('input', SalesController.updateTotal);
            DOM.invoiceTable.addEventListener("click", e => {
                const target = e.target.closest("button");
                if (!target) return;
                const index = target.dataset.index;
                if (target.classList.contains("remove-from-invoice-btn")) { appState.currentInvoice.splice(index, 1); }
                else if (target.classList.contains("increase-invoice-qty-btn")) { appState.currentInvoice[index].qty++; }
                else if (target.classList.contains("decrease-invoice-qty-btn")) { if (appState.currentInvoice[index].qty > 1) { appState.currentInvoice[index].qty--; } else { appState.currentInvoice.splice(index, 1); } }
                SalesController.renderInvoice();
            });
            DOM.saveInvoiceBtn.addEventListener("click", SalesController.saveInvoice);
            DOM.amountPaidInput.addEventListener("input", Helpers.calculateChange);
        }
    };
    App.init();
});
</script>
</body>
</html>
بعد إذنك أنا اختصرت الكود شوية عشان حجمه كان كبير ومش كل مرة هبعتهولك كامل 
لأني حذفت الأقسام اللي مش بنعدل فيها زي العملاء والتقارير والمستخدمين واحتفظت بس بقسم المبيعات اللي بنشتغل عليه 
لكن الكود عندي كامل زي ما بتبعتهولي
