<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نظام الفاتورة بالباركود</title>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Tahoma, sans-serif; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #444; padding: 5px; text-align: center; }
    #reader { width: 100%; margin: auto; }
    .controls { margin: 10px 0; }
    button { padding: 5px 10px; margin: 2px; }
  </style>
</head>
<body>
  <h2>💳 نظام البيع بالباركود</h2>

  <div id="reader"></div>

  <h3>الفاتورة</h3>
  <table>
    <thead>
      <tr>
        <th>المنتج</th>
        <th>السعر</th>
        <th>الكمية</th>
        <th>الإجمالي</th>
      </tr>
    </thead>
    <tbody id="invoice"></tbody>
    <tfoot>
      <tr>
        <td colspan="3">التوصيل</td>
        <td>
          <input type="number" id="delivery" value="20" style="width:70px;">
          <button onclick="changeDelivery(1)">+</button>
          <button onclick="changeDelivery(-1)">-</button>
        </td>
      </tr>
      <tr>
        <td colspan="3"><b>الإجمالي الكلي</b></td>
        <td id="total">0</td>
      </tr>
    </tfoot>
  </table>

  <script>
    // قائمة المنتجات التجريبية (ممكن تتغير لقاعدة بيانات)
    const products = {
      "123456789": { name: "بيبسي", price: 10 },
      "987654321": { name: "شيبسي", price: 5 },
      "111111111": { name: "شوكولاتة", price: 15 }
    };

    let invoice = [];
    let delivery = 20;

    // تحديث الفاتورة على الجدول
    function renderInvoice() {
      const tbody = document.getElementById("invoice");
      tbody.innerHTML = "";
      let total = 0;

      invoice.forEach(item => {
        const row = document.createElement("tr");
        const subtotal = item.price * item.qty;
        total += subtotal;

        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.price}</td>
          <td>${item.qty}</td>
          <td>${subtotal}</td>
        `;
        tbody.appendChild(row);
      });

      total += delivery;
      document.getElementById("total").innerText = total;
    }

    // إضافة منتج بالفاتورة
    function addProduct(code) {
      if (!products[code]) {
        alert("🚫 المنتج غير موجود!");
        return;
      }

      let item = invoice.find(p => p.code === code);
      if (item) {
        item.qty++;
      } else {
        invoice.push({ code, name: products[code].name, price: products[code].price, qty: 1 });
      }
      renderInvoice();
    }

    // التحكم في التوصيل
    document.getElementById("delivery").addEventListener("input", function() {
      delivery = parseFloat(this.value) || 0;
      renderInvoice();
    });

    function changeDelivery(step) {
      delivery += step;
      document.getElementById("delivery").value = delivery;
      renderInvoice();
    }

    // تشغيل الكاميرا وقراءة الباركود
    function onScanSuccess(decodedText) {
      addProduct(decodedText);
    }

    let html5QrcodeScanner = new Html5QrcodeScanner("reader", {
      fps: 10,
      qrbox: 250
    });
    html5QrcodeScanner.render(onScanSuccess);
  </script>
</body>
</html>