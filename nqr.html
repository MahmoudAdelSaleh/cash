<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام الفاتورة - متجرك</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script type="module">
    // استدعاء الفايربيز
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_DOMAIN",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER",
      appId: "YOUR_APPID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let products = [];
    let delivery = 30; // القيمة الافتراضية للتوصيل

    async function loadProducts() {
      const res = await fetch("p.json");
      products = await res.json();
    }

    async function loadClients() {
      const snap = await getDocs(collection(db, "clients"));
      const clientSelect = document.getElementById("client");
      snap.forEach(doc => {
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = doc.data().name;
        clientSelect.appendChild(opt);
      });
    }

    window.onload = () => {
      loadProducts();
      loadClients();
      updateDelivery();
    };

    function addItem(barcode) {
      const product = products.find(p => p.barcode == barcode);
      if (!product) return alert("الصنف غير موجود");

      const table = document.getElementById("invoiceBody");
      const row = table.insertRow();
      row.insertCell(0).innerText = product.name;
      row.insertCell(1).innerText = product.price;
      row.insertCell(2).innerHTML = `<input type="number" value="1" min="1" onchange="updateTotal()">`;
      row.insertCell(3).innerText = product.price;
      updateTotal();
    }

    function updateTotal() {
      let total = 0;
      const table = document.getElementById("invoiceBody");
      for (let i = 0; i < table.rows.length; i++) {
        const price = parseFloat(table.rows[i].cells[1].innerText);
        const qty = parseInt(table.rows[i].cells[2].children[0].value);
        const subtotal = price * qty;
        table.rows[i].cells[3].innerText = subtotal;
        total += subtotal;
      }
      total += delivery;
      document.getElementById("total").innerText = total + " جنيه";
    }

    function increaseDelivery() {
      delivery += 5;
      updateDelivery();
    }

    function decreaseDelivery() {
      if (delivery > 0) {
        delivery -= 5;
        updateDelivery();
      }
    }

    function updateDelivery() {
      document.getElementById("deliveryValue").innerText = delivery + " جنيه";
      updateTotal();
    }

    function sendWhatsApp() {
      let msg = "فاتورتك:\n";
      const table = document.getElementById("invoiceBody");
      for (let i = 0; i < table.rows.length; i++) {
        msg += `${table.rows[i].cells[0].innerText} × ${table.rows[i].cells[2].children[0].value} = ${table.rows[i].cells[3].innerText}\n`;
      }
      msg += `خدمة التوصيل: ${delivery} جنيه\n`;
      msg += `الإجمالي: ${document.getElementById("total").innerText}`;
      window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
    }
  </script>
</head>
<body>
  <h2>فاتورة المبيعات</h2>

  <label>العميل:</label>
  <select id="client">
    <option value="">-- اختر عميل --</option>
  </select>
  <br><br>

  <div id="reader" style="width:250px"></div>
  <br>

  <table border="1" width="100%">
    <thead>
      <tr>
        <th>الصنف</th>
        <th>السعر</th>
        <th>الكمية</th>
        <th>الإجمالي</th>
      </tr>
    </thead>
    <tbody id="invoiceBody"></tbody>
  </table>

  <br>
  <div style="display:flex;align-items:center;gap:10px;">
    <button onclick="decreaseDelivery()">-</button>
    <span>خدمة التوصيل: <span id="deliveryValue">30 جنيه</span></span>
    <button onclick="increaseDelivery()">+</button>
  </div>
  <br>

  <h3>الإجمالي: <span id="total">0 جنيه</span></h3>

  <button onclick="sendWhatsApp()">إرسال للواتساب</button>
</body>
</html>