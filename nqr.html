<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>كاشير متكامل - Firebase</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  :root {
    --primary-color: #007bff;
    --secondary-color: #343a40;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --text-dark: #222;
    --bg-light: #f8f9fa;
    --white: #fff;
    --border-color: #dee2e6;
    --shadow-light: 0 0 6px rgba(0, 0, 0, 0.1);
  }
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg-light); color: var(--text-dark); direction: rtl; }
  #app-container { display: none; }
  header { background: var(--primary-color); color: var(--white); padding: 15px; text-align: center; font-size: 24px; display: flex; justify-content: space-between; align-items: center; }
  nav { display: flex; background: var(--secondary-color); overflow-x: auto; }
  nav button { flex: 1 0 auto; padding: 12px 8px; border: none; background: var(--secondary-color); color: var(--white); font-size: 16px; cursor: pointer; transition: background 0.3s; white-space: nowrap; }
  nav button.active, nav button:hover { background: #0056b3; }
  nav button.hidden { display: none; }
  main { padding: 15px; max-width: 900px; margin: auto; }
  section { display: none; }
  section.active { display: block; }
  input, select, button, table { font-size: 16px; }
  input, select { width: 100%; padding: 10px; margin: 6px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
  button { background: var(--primary-color); color: var(--white); border: none; padding: 10px; border-radius: 4px; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  button:hover { background: #0056b3; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
  th { background: #e9ecef; }
  .btn-small { padding: 5px 10px; font-size: 14px; margin: 0 2px; border-radius: 3px; }
  .btn-danger { background: var(--danger-color); }
  .summary-box, .customer-card { background: var(--white); padding: 15px; margin: 15px 0; border-radius: 6px; box-shadow: var(--shadow-light); }
  #searchResults, #customerSuggestions { background: var(--white); max-height: 180px; overflow-y: auto; border: 1px solid #ccc; border-top: none; display: none; position: absolute; z-index: 1000; width: calc(100% - 110px); box-sizing: border-box; }
  #searchResults div, #customerSuggestions div { padding: 8px; cursor: pointer; border-bottom: 1px solid #ddd; }
  #searchResults div:hover, #customerSuggestions div:hover { background: #eee; }
  .flex-container { display: flex; gap: 10px; align-items: center; }
  #notification-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }
  .notification { background-color: rgba(0, 0, 0, 0.8); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); margin-bottom: 10px; opacity: 0; transition: opacity 0.5s ease-in-out; }
  .notification.show { opacity: 1; }
  #login-container { display: flex; align-items: center; justify-content: center; height: 100vh; }
  #login-form { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 350px; }
  #logoutBtn { background: var(--danger-color); }
  #barcode-scanner-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: white; padding: 20px; border-radius: 8px; z-index: 1001; border: 2px solid var(--primary-color); }
  #reader { width: 100%; }
</style>
</head>
<body>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  const firebaseConfig = {
    apiKey: "AIzaSyAWhNkYnC2n4iuHvdp1O_-S5suxivDidgc",
    authDomain: "cash-84acc.firebaseapp.com",
    projectId: "cash-84acc",
    storageBucket: "cash-84acc.appspot.com",
    messagingSenderId: "774737678098",
    appId: "1:774737678098:web:8b918375b4e51692b7edcb",
    measurementId: "G-GRKNPJ45N1"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window.addDocument = async (collectionName, data) => await addDoc(collection(db, collectionName), { ...data, createdAt: serverTimestamp() });
  window.readCollection = (collectionName, callback, orderByField = "createdAt", orderDirection = "desc") => {
    const q = query(collection(db, collectionName), orderBy(orderByField, orderDirection));
    return onSnapshot(q, snapshot => callback(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
  };
  window.updateDocument = async (collectionName, docId, data) => await updateDoc(doc(db, collectionName, docId), data);
  window.deleteDocument = async (collectionName, docId) => await deleteDoc(doc(db, collectionName, docId));
  window.getDocument = async (collectionName, docId) => {
    const docSnap = await getDoc(doc(db, collectionName, docId));
    return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
  };
</script>

<div id="login-container">
    <form id="login-form">
        <h2><i class="fas fa-lock"></i> تسجيل الدخول</h2>
        <div class="form-group"><input type="text" id="usernameInput" placeholder="اسم المستخدم" required /></div>
        <div class="form-group"><input type="password" id="passwordInput" placeholder="كلمة المرور" required /></div>
        <button type="submit" id="loginBtn"><i class="fas fa-sign-in-alt"></i> دخول</button>
    </form>
</div>

<div id="app-container">
  <header><span>كاشير متكامل</span><button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> خروج</button></header>
  <nav>
    <button data-tab="sales" class="active"><i class="fas fa-cash-register"></i> المبيعات</button>
    <button data-tab="items"><i class="fas fa-box"></i> الأصناف</button>
    <button data-tab="customers"><i class="fas fa-users"></i> العملاء</button>
    <button data-tab="invoices"><i class="fas fa-file-invoice"></i> الفواتير</button>
    <button data-tab="summary"><i class="fas fa-chart-bar"></i> التقارير</button>
    <button data-tab="users" class="hidden"><i class="fas fa-user-shield"></i> المستخدمون</button>
  </nav>

  <main>
    <section id="sales" class="active">
      <h2><i class="fas fa-cash-register"></i> عملية بيع</h2>
      <div class="form-group" style="position: relative;">
        <input type="text" id="customerName" placeholder="اسم العميل (اختياري)" autocomplete="off" />
        <div id="customerSuggestions"></div>
      </div>
      <div class="form-group" style="position: relative;">
        <div class="flex-container">
          <div style="flex-grow: 1; position: relative;">
              <input type="text" id="searchItem" placeholder="بحث بالكود أو اسم الصنف" autocomplete="off" />
              <div id="searchResults"></div>
          </div>
          <button id="scanBarcodeBtn" style="flex-shrink: 0; width: 100px;"><i class="fas fa-camera"></i> مسح</button>
        </div>
      </div>
      <div class="form-group flex-container">
        <label for="quantitySelect">الكمية:</label>
        <select id="quantitySelect"></select>
        <button id="addToInvoiceBtn"><i class="fas fa-plus-circle"></i> إضافة للفاتورة</button>
      </div>
      <h3><i class="fas fa-file-invoice"></i> تفاصيل الفاتورة</h3>
      <table>
        <thead><tr><th>اسم الصنف</th><th>كمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th>حذف</th></tr></thead>
        <tbody id="invoiceTable"></tbody>
      </table>
      <h3 style="text-align: left;">إجمالي الفاتورة: <span id="invoiceTotal">0.00</span> ج.م</h3>
      <div class="form-group flex-container">
        <label for="paymentMethodSelect">طريقة الدفع:</label>
        <select id="paymentMethodSelect">
          <option value="cash">نقداً</option>
          <option value="visa">فيزا</option>
        </select>
        <input type="number" id="amountPaidInput" placeholder="المبلغ المدفوع" min="0" />
      </div>
      <h3 style="text-align: left;">
        <span id="changeText">الباقي للعميل:</span><span id="changeAmount">0.00</span> ج.م
      </h3>
      <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button id="printInvoiceBtn" class="btn-success"><i class="fas fa-print"></i> طباعة</button>
        <button id="saveInvoiceBtn"><i class="fas fa-save"></i> حفظ الفاتورة</button>
      </div>
    </section>

    <section id="items">
      <h2><i class="fas fa-box"></i> إدارة الأصناف (للعرض فقط)</h2>
      <table>
        <thead><tr><th>كود</th><th>اسم</th><th>وحدة</th><th>سعر</th><th>مخزون</th><th>فئة</th></tr></thead>
        <tbody id="itemsTable"></tbody>
      </table>
    </section>

    <section id="customers">
        </section>
    <section id="invoices">
        <h2><i class="fas fa-file-invoice-dollar"></i> الفواتير المحفوظة</h2>
        <div id="invoicesList"></div>
    </section>
    <section id="summary">
        <h2><i class="fas fa-chart-bar"></i> التقارير</h2>
        <div id="summaryContent"></div>
    </section>
    <section id="users">
        </section>
  </main>
</div>

<div id="barcode-scanner-container" style="display:none;">
    <div id="reader"></div>
    <button id="closeScannerBtn" class="btn-danger btn-small">إغلاق</button>
</div>
<div id="notification-container"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const DOM = {
        appContainer: document.getElementById("app-container"),
        loginContainer: document.getElementById("login-container"),
        loginForm: document.getElementById("login-form"),
        usernameInput: document.getElementById("usernameInput"),
        passwordInput: document.getElementById("passwordInput"),
        logoutBtn: document.getElementById("logoutBtn"),
        navButtons: document.querySelectorAll("nav button"),
        sections: document.querySelectorAll("main section"),
        customerNameInput: document.getElementById("customerName"),
        customerSuggestionsDiv: document.getElementById("customerSuggestions"),
        searchItemInput: document.getElementById("searchItem"),
        searchResultsDiv: document.getElementById("searchResults"),
        scanBarcodeBtn: document.getElementById("scanBarcodeBtn"),
        barcodeScannerContainer: document.getElementById("barcode-scanner-container"),
        closeScannerBtn: document.getElementById("closeScannerBtn"),
        quantitySelect: document.getElementById("quantitySelect"),
        addToInvoiceBtn: document.getElementById("addToInvoiceBtn"),
        invoiceTable: document.getElementById("invoiceTable"),
        invoiceTotalSpan: document.getElementById("invoiceTotal"),
        saveInvoiceBtn: document.getElementById("saveInvoiceBtn"),
        printInvoiceBtn: document.getElementById("printInvoiceBtn"),
        paymentMethodSelect: document.getElementById("paymentMethodSelect"),
        amountPaidInput: document.getElementById("amountPaidInput"),
        changeTextSpan: document.getElementById("changeText"),
        changeAmountSpan: document.getElementById("changeAmount"),
        notificationContainer: document.getElementById("notification-container"),
        itemsTable: document.getElementById("itemsTable"),
        invoicesList: document.getElementById("invoicesList"),
        summaryContent: document.getElementById("summaryContent"),
    };

    let appState = {
        items: [], invoices: [], customers: [], users: [], adminPIN: null, currentUser: null,
        currentInvoice: [], selectedItem: null, selectedCustomer: null, html5QrCode: null
    };

    const Helpers = {
        showNotification: (message, duration = 3000) => {
            const el = document.createElement("div");
            el.className = "notification";
            el.textContent = message;
            DOM.notificationContainer.appendChild(el);
            setTimeout(() => el.classList.add("show"), 10);
            setTimeout(() => {
                el.classList.remove("show");
                setTimeout(() => el.remove(), 500);
            }, duration);
        },
        convertToArabicAndEnglishDigits: (text) => {
            if (!text) return "";
            return text.toString().replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d));
        },
        calculateChange: () => {
            const total = parseFloat(DOM.invoiceTotalSpan.textContent) || 0;
            const paid = parseFloat(DOM.amountPaidInput.value) || 0;
            const change = paid - total;
            DOM.changeTextSpan.textContent = change >= 0 ? "الباقي للعميل:" : "المطلوب منه:";
            DOM.changeAmountSpan.textContent = Math.abs(change).toFixed(2);
        }
    };

    const Auth = {
        login: (username, password) => {
            const pin = Helpers.convertToArabicAndEnglishDigits(password);
            if (pin === appState.adminPIN) {
                appState.currentUser = { username: "المدير", role: "admin" };
                localStorage.setItem('currentUser', JSON.stringify(appState.currentUser));
                Auth.showApp("admin");
                return;
            }
            const user = appState.users.find(u => u.username === username && u.password === pin);
            if (user) {
                appState.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                Auth.showApp("user");
            } else { Helpers.showNotification("بيانات الدخول غير صحيحة"); }
        },
        logout: () => {
            appState.currentUser = null;
            localStorage.removeItem('currentUser');
            location.reload();
        },
        showApp: (role) => {
            DOM.loginContainer.style.display = "none";
            DOM.appContainer.style.display = "block";
        }
    };

    const SalesController = {
        renderInvoice: () => {
            let total = 0;
            DOM.invoiceTable.innerHTML = appState.currentInvoice.map((item, index) => {
                const subtotal = item.price * item.qty;
                total += subtotal;
                return `<tr><td>${item.name}</td><td>${item.qty}</td><td>${item.price.toFixed(2)}</td><td>${subtotal.toFixed(2)}</td><td><button class="btn-small btn-danger remove-from-invoice-btn" data-index="${index}"><i class="fas fa-trash-alt"></i></button></td></tr>`;
            }).join("");
            DOM.invoiceTotalSpan.textContent = total.toFixed(2);
            Helpers.calculateChange();
        },
        addToInvoice: () => {
            if (!appState.selectedItem) { Helpers.showNotification("يرجى اختيار صنف"); return; }
            const qty = parseInt(DOM.quantitySelect.value);
            const existingItem = appState.currentInvoice.find(i => i.id === appState.selectedItem.id);
            if (existingItem) {
                existingItem.qty += qty;
            } else {
                appState.currentInvoice.push({ ...appState.selectedItem, qty: qty });
            }
            SalesController.renderInvoice();
            DOM.searchItemInput.value = "";
            appState.selectedItem = null;
        },
        saveInvoice: async () => {
            if (appState.currentInvoice.length === 0) { Helpers.showNotification("الفاتورة فارغة"); return; }
            const total = parseFloat(DOM.invoiceTotalSpan.textContent);
            const newInvoice = {
                customerName: DOM.customerNameInput.value.trim(),
                paymentMethod: DOM.paymentMethodSelect.value,
                amountPaid: parseFloat(DOM.amountPaidInput.value) || 0,
                changeOrBalance: (parseFloat(DOM.amountPaidInput.value) || 0) - total,
                items: [...appState.currentInvoice],
                total: total,
            };
            try {
                await window.addDocument("invoices", newInvoice);
                Helpers.showNotification("تم حفظ الفاتورة بنجاح!");
                appState.currentInvoice = [];
                DOM.customerNameInput.value = "";
                DOM.amountPaidInput.value = "";
                SalesController.renderInvoice();
            } catch (error) {
                console.error("Save Invoice Error:", error);
                Helpers.showNotification("حدث خطأ أثناء حفظ الفاتورة.");
            }
        },
    };
    
    const ReportsController = {
        renderInvoices: () => {
            if (appState.invoices.length === 0) {
                DOM.invoicesList.innerHTML = "<p>لا توجد فواتير محفوظة.</p>";
                return;
            }
            DOM.invoicesList.innerHTML = appState.invoices.map(inv => {
                const date = inv.createdAt.toDate().toLocaleString('ar-EG');
                return `<div class="summary-box">
                    <p><strong>التاريخ:</strong> ${date}</p>
                    <p><strong>العميل:</strong> ${inv.customerName || 'نقدي'}</p>
                    <p><strong>الإجمالي:</strong> ${inv.total.toFixed(2)} ج.م</p>
                    <ul>${inv.items.map(i => `<li>${i.name} (الكمية: ${i.qty})</li>`).join('')}</ul>
                </div>`;
            }).join('');
        },
        renderSummary: () => {
            const totalSales = appState.invoices.reduce((sum, inv) => sum + inv.total, 0);
            DOM.summaryContent.innerHTML = `<div class="summary-box"><h3>إجمالي المبيعات</h3><p>${totalSales.toFixed(2)} ج.م</p></div>`;
        }
    };

    const App = {
        init: async () => {
            App.bindEvents();
            App.listenToFirebase();
            try {
                const response = await fetch('p.json');
                appState.items = await response.json();
                DOM.itemsTable.innerHTML = appState.items.map(item => `<tr><td>${item.sku}</td><td>${item.name}</td><td>قطعة</td><td>${item.price.toFixed(2)}</td><td>999</td><td>${item['category ']}</td></tr>`).join('');
            } catch (error) { console.error("Could not load p.json", error); }
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) { appState.currentUser = JSON.parse(savedUser); Auth.showApp(appState.currentUser.role); }
            for (let i = 1; i <= 100; i++) {
                DOM.quantitySelect.innerHTML += `<option value="${i}">${i}</option>`;
            }
        },
        listenToFirebase: () => {
            window.readCollection("customers", data => appState.customers = data, "name", "asc");
            window.readCollection("invoices", data => { appState.invoices = data; if(document.getElementById('invoices').classList.contains('active')) ReportsController.renderInvoices(); if(document.getElementById('summary').classList.contains('active')) ReportsController.renderSummary();});
            window.readCollection("users", data => appState.users = data, "username", "asc");
            window.getDocument("config", "admin").then(doc => { appState.adminPIN = doc?.pin || "790707071"; });
        },
        bindEvents: () => {
            DOM.loginForm.addEventListener("submit", e => { e.preventDefault(); Auth.login(DOM.usernameInput.value, DOM.passwordInput.value); });
            DOM.logoutBtn.addEventListener("click", Auth.logout);
            DOM.navButtons.forEach(btn => btn.addEventListener("click", e => {
                const tabId = e.currentTarget.dataset.tab;
                DOM.navButtons.forEach(b => b.classList.remove("active"));
                e.currentTarget.classList.add("active");
                DOM.sections.forEach(s => s.classList.toggle("active", s.id === tabId));
                if (tabId === 'invoices') ReportsController.renderInvoices();
                if (tabId === 'summary') ReportsController.renderSummary();
            }));
            DOM.searchItemInput.addEventListener("input", e => {
                const query = e.target.value.toLowerCase();
                if (query.length < 2) { DOM.searchResultsDiv.style.display = 'none'; return; }
                const matched = appState.items.filter(item => item.name.toLowerCase().includes(query) || item.sku.includes(query));
                DOM.searchResultsDiv.innerHTML = matched.map(item => `<div data-id="${item.sku}">${item.name}</div>`).join('');
                DOM.searchResultsDiv.style.display = matched.length > 0 ? 'block' : 'none';
            });
            DOM.searchResultsDiv.addEventListener("click", e => {
                const id = e.target.dataset.id;
                const selected = appState.items.find(item => item.sku === id);
                if (selected) {
                    appState.selectedItem = { id: selected.sku, code: selected.sku, name: selected.name, price: selected.price };
                    DOM.searchItemInput.value = selected.name;
                    DOM.searchResultsDiv.style.display = 'none';
                }
            });
            DOM.scanBarcodeBtn.addEventListener('click', () => {
                DOM.barcodeScannerContainer.style.display = 'block';
                if (!appState.html5QrCode) { appState.html5QrCode = new Html5Qrcode("reader"); }
                const onScanSuccess = (decodedText) => {
                    appState.html5QrCode.stop().then(() => {
                        DOM.barcodeScannerContainer.style.display = 'none';
                        let codeToSearch = null;
                        const parts = decodedText.split('|');
                        if (parts.length >= 5) { codeToSearch = parts[4].trim(); } 
                        else { let barcode = decodedText.trim(); codeToSearch = barcode.length > 12 ? barcode.slice(-12) : barcode; }
                        const foundItem = appState.items.find(item => item.sku === codeToSearch);
                        if (foundItem) {
                            appState.selectedItem = { id: foundItem.sku, code: foundItem.sku, name: foundItem.name, price: foundItem.price };
                            SalesController.addToInvoice();
                        } else { Helpers.showNotification(`صنف غير موجود`); }
                    });
                };
                appState.html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: {width: 250, height: 250} }, onScanSuccess, () => {})
                .catch(() => Helpers.showNotification("خطأ في تشغيل الكاميرا"));
            });
            DOM.closeScannerBtn.addEventListener('click', () => { if (appState.html5QrCode?.isScanning) { appState.html5QrCode.stop(); } DOM.barcodeScannerContainer.style.display = 'none'; });
            DOM.addToInvoiceBtn.addEventListener("click", SalesController.addToInvoice);
            DOM.invoiceTable.addEventListener("click", e => {
                if (e.target.classList.contains("remove-from-invoice-btn")) {
                    const index = e.target.dataset.index;
                    appState.currentInvoice.splice(index, 1);
                    SalesController.renderInvoice();
                }
            });
            DOM.saveInvoiceBtn.addEventListener("click", SalesController.saveInvoice);
            DOM.amountPaidInput.addEventListener("input", Helpers.calculateChange);
        }
    };
    App.init();
});
</script>
</body>
</html>
