<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© - Ù…ØªØ¬Ø±Ùƒ</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Tahoma, sans-serif; margin:0; padding:10px; background:#f5f5f5; }
    header { text-align:center; padding:10px; font-size:22px; background:#007bff; color:#fff; }
    .field { margin-bottom:10px; }
    label { display:block; margin-bottom:4px; font-weight:bold; }
    input { width:100%; padding:8px; border-radius:5px; border:1px solid #ccc; font-size:16px; }
    button { width:100%; padding:10px; margin-top:8px; font-size:18px; border:none; border-radius:5px; background:#28a745; color:#fff; cursor:pointer; }
    button:hover { opacity:0.9; }
    table { width:100%; border-collapse:collapse; margin-top:15px; font-size:16px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#007bff; color:#fff; }
    #reader { width:100%; max-width:400px; margin:10px auto; }
    .delivery { margin-top:10px; display:flex; align-items:center; gap:5px; }
    .delivery input { width:100px !important; }
    .total { margin-top:15px; font-size:20px; text-align:center; font-weight:bold; }
    #customerSuggestions { background:#fff; max-height:150px; overflow-y:auto; border:1px solid #ccc; position:absolute; z-index:100; width:90%; display:none; }
    #customerSuggestions div { padding:8px; cursor:pointer; border-bottom:1px solid #eee; }
    #customerSuggestions div:hover { background:#f5f5f5; }
  </style>
</head>
<body>

<header>
  <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø±" style="max-height:50px; vertical-align:middle;">
  <span> ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹</span>
</header>

<div class="field" style="position:relative;">
  <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
  <input type="text" id="customerName" placeholder="Ø§ÙƒØªØ¨ Ø£ÙˆÙ„ Ø£Ø­Ø±Ù Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
  <div id="customerSuggestions"></div>
</div>

<div class="field">
  <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
  <input type="tel" id="customerPhone" placeholder="201xxxxxxxxx" disabled>
</div>

<button onclick="startScanner()">  ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</button>
<div id="reader"></div>

<table>
  <thead>
    <tr>
      <th>Ø§Ù„ØµÙ†Ù</th>
      <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
      <th>Ø§Ù„Ø³Ø¹Ø±</th>
      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
      <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
    </tr>
  </thead>
  <tbody id="invoiceBody"></tbody>
</table>

<div class="delivery">
  <label>Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø¬Ù†ÙŠÙ‡):</label>
  <button onclick="changeDelivery(-5)">-5</button>
  <input type="number" id="delivery" value="10" min="0" onchange="updateTotal()">
  <button onclick="changeDelivery(5)">+5</button>
</div>

<div class="total">
  Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="totalAmount">0.00</span> Ø¬.Ù…
</div>

<button onclick="sendWhatsApp()">  Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { Html5Qrcode } from "https://unpkg.com/html5-qrcode@2.3.4/dist/html5-qrcode.min.js";

  // Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡Ø§)
  const firebaseConfig = {
    apiKey: "AIzaSyAWhNkYnC2n4iuHvdp1O_-S5suxivDidgc",
    authDomain: "cash-84acc.firebaseapp.com",
    projectId: "cash-84acc",
    storageBucket: "cash-84acc.appspot.com",
    messagingSenderId: "774737678098",
    appId: "1:774737678098:web:8b918375b4e51692b7edcb"
  };

  // ØªÙ‡ÙŠØ¦Ø© Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let invoice = {};
  let allCustomers = [];
  
  // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  async function fetchAllCustomers() {
    const customersRef = collection(db, "customers");
    const querySnapshot = await getDocs(customersRef);
    allCustomers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
  async function searchCustomers() {
    const searchTerm = document.getElementById('customerName').value.trim().toLowerCase();
    const suggestionsDiv = document.getElementById('customerSuggestions');
    suggestionsDiv.innerHTML = '';
    
    if (searchTerm.length > 0) {
      const matchedCustomers = allCustomers.filter(customer =>
        customer.name.toLowerCase().includes(searchTerm)
      );

      if (matchedCustomers.length > 0) {
        suggestionsDiv.style.display = 'block';
        matchedCustomers.forEach(customer => {
          const div = document.createElement('div');
          div.textContent = `${customer.name} - ${customer.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø§ØªÙ'}`;
          div.onclick = () => {
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone || '';
            suggestionsDiv.style.display = 'none';
          };
          suggestionsDiv.appendChild(div);
        });
      } else {
        suggestionsDiv.style.display = 'none';
      }
    } else {
      suggestionsDiv.style.display = 'none';
    }
  }

  // Ø±Ø¨Ø· Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
  document.addEventListener('DOMContentLoaded', () => {
    fetchAllCustomers();
    document.getElementById('customerName').addEventListener('input', searchCustomers);

    // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', (e) => {
        const suggestionsDiv = document.getElementById('customerSuggestions');
        if (!e.target.closest('.field')) {
            suggestionsDiv.style.display = 'none';
        }
    });
  });

  async function getProductByBarcode(barcode) {
    const productsRef = collection(db, "items");
    const q = query(productsRef, where("code", "==", barcode));
    const querySnapshot = await getDocs(q);
    if (!querySnapshot.empty) {
      return querySnapshot.docs[0].data();
    }
    return null;
  }

  function startScanner() {
    const qr = new Html5Qrcode("reader");
    qr.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      async (code) => {
        const product = await getProductByBarcode(code);
        if (product) {
          addProduct(product, code);
        } else {
          alert("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }
        qr.stop();
      },
      (err) => {}
    );
  }

  function addProduct(product, barcode) {
    if (!invoice[barcode]) invoice[barcode] = { ...product, qty: 0 };
    invoice[barcode].qty++;
    renderInvoice();
  }

  function renderInvoice() {
    const tbody = document.getElementById("invoiceBody");
    tbody.innerHTML = "";
    let total = 0;
    for (const code in invoice) {
      const item = invoice[code];
      const rowTotal = item.price * item.qty;
      total += rowTotal;
      tbody.innerHTML += `<tr>
        <td>${item.name}</td>
        <td>${item.unit}</td>
        <td>${item.price.toFixed(2)}</td>
        <td>${item.qty}</td>
        <td>${rowTotal.toFixed(2)}</td>
      </tr>`;
    }
    const delivery = parseFloat(document.getElementById("delivery").value) || 0;
    document.getElementById("totalAmount").innerText = (total + delivery).toFixed(2);
  }

  function changeDelivery(val) {
    const inp = document.getElementById("delivery");
    inp.value = Math.max(0, parseFloat(inp.value) + val);
    updateTotal();
  }

  function updateTotal() {
    renderInvoice();
  }

  function sendWhatsApp() {
    const name = document.getElementById("customerName").value.trim();
    const phone = document.getElementById("customerPhone").value.trim();
    if (!name || !phone) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");

    let msg = `*ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ù…ØªØ¬Ø±Ùƒ* \nğŸ§¾ Ø¹Ù…ÙŠÙ„: ${name}\nğŸ“ ${phone}\n\n`;
    let total = 0;
    for (const code in invoice) {
      const item = invoice[code];
      const rowT = item.price * item.qty;
      msg += `${item.name} (${item.unit}) x${item.qty} = ${rowT.toFixed(2)} Ø¬.Ù…\n`;
      total += rowT;
    }

    const delivery = parseFloat(document.getElementById("delivery").value) || 0;
    total += delivery;
    msg += `\nğŸšš Ø§Ù„ØªÙˆØµÙŠÙ„: ${delivery.toFixed(2)} Ø¬.Ù…\nğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)} Ø¬.Ù…\n`;
    msg += "\nØ´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ù…ØªØ¬Ø±Ù†Ø§ ğŸŒ¹";

    const url = `https://wa.me/${phone.replace(/^0/, "20")}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
  }

  window.startScanner = startScanner;
  window.changeDelivery = changeDelivery;
  window.updateTotal = updateTotal;
  window.sendWhatsApp = sendWhatsApp;
</script>
</body>
</html>
